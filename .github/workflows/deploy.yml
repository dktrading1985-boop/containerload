   - name: Decode and add SSH key (base64) â€” robust diagnostics
     env:
       KEY_B64: ${{ secrets.DO_SSH_PRIVATE_KEY_B64 }}
     run: |
       set -euo pipefail
       mkdir -p ~/.ssh
       chmod 700 ~/.ssh

       if [ -z "${KEY_B64:-}" ]; then
         echo "ERROR: DO_SSH_PRIVATE_KEY_B64 is empty"
         exit 1
       fi

       echo "Secret length (chars): ${#KEY_B64}"

       # Try decoding; strip CRs if necessary
       DECODED=~/.ssh/id_rsa.raw
       if echo "$KEY_B64" | base64 -d > "$DECODED" 2>/dev/null; then
         echo "Decoded with base64 -d"
       elif echo "$KEY_B64" | base64 --decode > "$DECODED" 2>/dev/null; then
         echo "Decoded with base64 --decode"
       else
         echo "First decode failed; attempting to strip CR and retry."
         if echo "$KEY_B64" | tr -d '\r' | base64 -d > "$DECODED" 2>/dev/null; then
           echo "Decoded after stripping CR with base64 -d"
         elif echo "$KEY_B64" | tr -d '\r' | base64 --decode > "$DECODED" 2>/dev/null; then
           echo "Decoded after stripping CR with base64 --decode"
         else
           echo "ERROR: base64 decode failed. Check DO_SSH_PRIVATE_KEY_B64 content."
           exit 1
         fi
       fi

       # Move decoded bytes to final key path and set perms
       CLEAN=~/.ssh/id_rsa
       mv "$DECODED" "$CLEAN"
       chmod 600 "$CLEAN"

       echo "==== Diagnostics: file, head (safe), hexdump ===="
       file "$CLEAN" || true
       echo "---- head (first line, non-printables removed) ----"
       head -c 120 "$CLEAN" | tr -c '[:print:]\n' '.' | sed -n '1,3p' || true
       echo "---- hexdump first 64 bytes ----"
       head -c 64 "$CLEAN" | xxd -g 1 -l 64 || true
       echo "---- end diagnostics ----"

       # Validate key with ssh-keygen (accepts all supported private key formats)
       if ssh-keygen -lf "$CLEAN" 2>/dev/null; then
         echo "ssh-keygen fingerprint displayed above. Key is valid."
       else
         echo "ssh-keygen failed to parse the key (libcrypto). The key file may be corrupted or in an unsupported format."
         exit 1
       fi
